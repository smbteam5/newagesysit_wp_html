<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>COBE Globe — dropdown, idle rotate, drag</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      :root {
        --max-width: 720px;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, "Segoe UI", Roboto,
          "Helvetica Neue", Arial;
        display: flex;
        min-height: 100vh;
        align-items: center;
        justify-content: center;
        background: #000;
        color: #111;
      }
      .card {
        width: 100%;
        max-width: var(--max-width);
        margin: 1rem;
      }
      #globeWrap {
        position: relative;
        width: 100%;
        aspect-ratio: 1;
        max-width: var(--max-width);
        margin: 0 auto;
        border-radius: 14px;
        overflow: hidden;
        box-shadow: 0 8px 30px rgba(10, 10, 10, 0.08);
        touch-action: none;
      }
      canvas {
        width: 100%;
        height: 100%;
        display: block;
        opacity: 0;
        transition: opacity 600ms ease;
        background: transparent;
        cursor: grab;
      }
      canvas:active {
        cursor: grabbing;
      }
      .controls {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        justify-content: center;
        padding: 0.8rem 0;
        flex-wrap: wrap;
        user-select: none;
        background-color: #fff;
      }
      select,
      button {
        appearance: none;
        -webkit-appearance: none;
        font-size: 14px;
        padding: 6px 10px;
        border-radius: 8px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        background: rgba(0, 0, 0, 0.03);
        cursor: pointer;
      }
      .small {
        font-size: 13px;
        padding: 6px 8px;
      }
      .legend {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        color: #444;
        font-size: 13px;
      }
      .dot-swatch {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: black;
        box-shadow: 0 0 6px rgba(0, 0, 0, 0.25);
      }
      /* Tooltip Styles were removed as the underlying globe functions aren't available */
      @media (max-width: 420px) {
        .controls {
          gap: 0.4rem;
          padding: 0.6rem 0;
        }
        select,
        button {
          padding: 6px 8px;
          font-size: 13px;
        }
      }
    </style>
  </head>
  <body>
    <div class="card">
      <div class="controls" style="margin-top: 0.6rem">
        <label for="locationSelect" style="font-size: 14px">Choose focus</label>
        <select id="locationSelect" class="small">
          <option value="" disabled selected>Select Location</option>
        </select>
        <button id="fitButton" class="small">Fit / Center</button>

        <label for="mapToggle" style="font-size: 14px">Toggle Map</label>
        <select id="mapToggle" class="small">
          <option value="" disabled selected>Select Location</option>
          <option value="us">U.S. locations</option>
          <option value="global">Global map</option>
        </select>

        <div class="legend" style="margin-left: 0.6rem">
          <div class="dot-swatch" aria-hidden="true"></div>
          <div>Marker</div>
        </div>
      </div>
      <div id="globeWrap">
        <canvas id="cobeCanvas"></canvas>
      </div>
    </div>

    <script type="module">
      import createGlobe from "https://cdn.skypack.dev/cobe";

      // ---- Config ----
      const LOCATIONS = [
        {
          name: "Custom Software Development — New Jersey",
          lat: 40.7128, // New Jersey Latitude
          lon: -74.006, // New Jersey Longitude
          size: 0.1,
          type: "us", // U.S. location
        },
        {
          name: "Software Development — Mumbai",
          lat: 19.076,
          lon: 72.8777,
          size: 0.1,
          type: "global", // Global location
        },
        {
          name: "Development Center — Beijing",
          lat: 39.9042,
          lon: 116.4074,
          size: 0.09,
          type: "global", // Global location
        },
        {
          name: "App Development — Osaka",
          lat: 34.6937,
          lon: 135.5022,
          size: 0.085,
          type: "global", // Global location
        },
      ];

      function locationToAngles(latDeg, lonDeg) {
        return [
          Math.PI - ((lonDeg * Math.PI) / 180 - Math.PI / 2), // phi
          (latDeg * Math.PI) / 180, // theta
        ];
      }

      const canvas = document.getElementById("cobeCanvas");
      const selectEl = document.getElementById("locationSelect");
      const fitButton = document.getElementById("fitButton");
      const mapToggleEl = document.getElementById("mapToggle");

      // --- NEW: Mutable Globe Configuration ---
      // This object holds the dynamic markers list, which onRender will read.
      const globeConfig = {
        markers: LOCATIONS.filter((loc) => loc.type === "global").map((l) => ({
          location: [l.lat, l.lon],
          size: l.size,
          name: l.name,
        })),
      };
      // ----------------------------------------

      // Populate select
      LOCATIONS.forEach((loc, idx) => {
        const opt = document.createElement("option");
        opt.value = idx;
        opt.textContent = loc.name;
        selectEl.appendChild(opt);
      });

      // State
      let widthCss = 0;
      let widthPx = 0;
      let currentPhi = 0;
      let currentTheta = 0.3;
      let focusPhi = 0;
      let focusTheta = 0;
      let lastInteractionTime = Date.now();

      let isDragging = false;
      let dragStartX = 0;
      let dragStartY = 0;
      let dragStartPhi = 0;
      let dragStartTheta = 0;

      // Set default focus to first location
      selectEl.selectedIndex = 0;
      [focusPhi, focusTheta] = locationToAngles(
        LOCATIONS[0].lat,
        LOCATIONS[0].lon
      );

      // Responsive sizing helper
      function recomputeSizes() {
        widthCss = canvas.offsetWidth;
        widthPx = Math.max(2, Math.floor(widthCss * 2));
      }
      window.addEventListener("resize", recomputeSizes);
      recomputeSizes();

      // Pointer (mouse/touch) handlers for drag rotation
      canvas.addEventListener("pointerdown", (e) => {
        canvas.setPointerCapture(e.pointerId);
        isDragging = true;
        dragStartX = e.clientX;
        dragStartY = e.clientY;
        dragStartPhi = currentPhi;
        dragStartTheta = currentTheta;
        lastInteractionTime = Date.now();
      });

      canvas.addEventListener("pointermove", (e) => {
        if (!isDragging) return;
        const dx = e.clientX - dragStartX;
        const dy = e.clientY - dragStartY;
        const deltaPhi = (dx / Math.max(200, widthCss)) * Math.PI * 2;
        const deltaTheta = (dy / Math.max(200, widthCss)) * Math.PI;
        currentPhi = dragStartPhi + deltaPhi;
        currentTheta = clamp(
          dragStartTheta + deltaTheta,
          -Math.PI / 2 + 0.01,
          Math.PI / 2 - 0.01
        );
        lastInteractionTime = Date.now();
      });

      canvas.addEventListener("pointerup", (e) => {
        if (isDragging) {
          isDragging = false;
          try {
            canvas.releasePointerCapture(e.pointerId);
          } catch {}
          focusPhi = currentPhi;
          focusTheta = currentTheta;
          lastInteractionTime = Date.now();
        }
      });

      // Utility clamp
      function clamp(v, a, b) {
        return Math.max(a, Math.min(b, v));
      }

      // Create globe
      const globe = createGlobe(canvas, {
        devicePixelRatio: 2,
        width: widthPx || 600,
        height: widthPx || 600,
        phi: currentPhi,
        theta: currentTheta,
        dark: 0,
        diffuse: 3,
        mapSamples: 16000,
        mapBrightness: 1.15,
        baseColor: [1, 1, 1], // white globe
        markerColor: [0, 0, 0], // black dots
        glowColor: [1, 1, 1],
        // Pass the *initial* markers from the mutable config
        markers: globeConfig.markers,
        onRender: (state) => {
          recomputeSizes();
          state.width = widthPx;
          state.height = widthPx;

          // --- NEW: Update markers from the mutable config every frame ---
          state.markers = globeConfig.markers;
          // -----------------------------------------------------------------

          // Smoothly update the rotation towards the new focus
          const rotationSpeed = 0.1; // Adjust this speed for smoother transition
          currentPhi = currentPhi + (focusPhi - currentPhi) * rotationSpeed;
          currentTheta =
            currentTheta + (focusTheta - currentTheta) * rotationSpeed;

          state.phi = currentPhi;
          state.theta = currentTheta;
        },
      });

      // Fade in canvas
      setTimeout(() => (canvas.style.opacity = "1"), 10);

      // Dropdown & fit button
      selectEl.addEventListener("change", (e) => {
        const idx = Number(e.target.value); // Get the selected index
        const angs = locationToAngles(LOCATIONS[idx].lat, LOCATIONS[idx].lon); // Get angles from selected location
        focusPhi = angs[0];
        focusTheta = angs[1];
        lastInteractionTime = Date.now();

        // Rotation is handled by onRender loop (currentPhi/Theta smoothly follow focusPhi/Theta)

        // Reset the map toggle when a location is selected
        mapToggleEl.selectedIndex = 0; // Reset map toggle to "Select Location"
      });

      fitButton.addEventListener("click", () => {
        const idx = Number(selectEl.value || 0);
        const angs = locationToAngles(LOCATIONS[idx].lat, LOCATIONS[idx].lon);
        focusPhi = angs[0];
        focusTheta = angs[1];
        lastInteractionTime = Date.now();
      });

      // Map toggle functionality
      mapToggleEl.addEventListener("change", (e) => {
        const selected = e.target.value;
        if (selected === "us") {
          // Focus on U.S. location (e.g., New Jersey)
          focusPhi = Math.PI - ((-74.006 * Math.PI) / 180 - Math.PI / 2); // New Jersey
          focusTheta = (40.7128 * Math.PI) / 180;

          // --- FIX: Update the mutable config instead of calling updateMarkers ---
          globeConfig.markers = LOCATIONS.filter(
            (loc) => loc.type === "us"
          ).map((l) => ({
            location: [l.lat, l.lon],
            size: l.size,
            name: l.name,
          }));
          // ---------------------------------------------------------------------
          selectEl.disabled = true;
        } else {
          // --- FIX: Update the mutable config instead of calling updateMarkers ---
          // Show all locations (global and us)
          globeConfig.markers = LOCATIONS.map((l) => ({
            location: [l.lat, l.lon],
            size: l.size,
            name: l.name,
          }));
          // ---------------------------------------------------------------------
          selectEl.disabled = false;
        }

        // Reset locationSelect to placeholder
        selectEl.selectedIndex = 0;
      });

      // Cleanup on unload
      window.addEventListener("beforeunload", () => {
        try {
          globe.destroy();
        } catch (e) {}
      });

      // Ensure focusPhi/focusTheta start from the selected location
      (function initFocusFromSelect() {
        const idx = Number(selectEl.value || 0);
        const angs = locationToAngles(LOCATIONS[idx].lat, LOCATIONS[idx].lon);
        focusPhi = angs[0];
        focusTheta = angs[1];
        currentPhi = focusPhi;
        currentTheta = focusTheta;
      })();
    </script>
  </body>
</html>
